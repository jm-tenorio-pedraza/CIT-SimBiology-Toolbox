%% DREAM MCMC
finalValues = log([PI.par(:).finalValue]);
N = length(finalValues);

X0 =[ (finalValues); randn(100,length(finalValues))*0.0025 + finalValues];
logL=rowfun(obj_fun,table(X0));
[L,I]=sort(logL{:,:});


h.IndividualParams=[];
p=parpool('local')
tic
[x, p_x,accept,pCR,stepSize, J, n_id] = dreamHParallel(w0,likelihood_fun,prior_fun_MCMC,...
    size(w0,1),ceil(3e5/size(w0,1)), length(finalValues), 'BurnIn', ...
    5e5,'StepSize',2.38,'H', h);
toc
w0 = x(:,:,end);
tic
[x2, p_x2,accept2,pCR2,stepSize2,J2,n_id2] = dreamHParallel(w0',likelihood_fun,prior_fun_MCMC,...
    size(w0,1),ceil(2.5e5/size(w0,1)), length(finalValues), 'BurnIn', ...
    3e5,'StepSize',stepSize,'H', h,'pCR', pCR, 'J', J, 'n_id', n_id);
toc
w0 = x2(:,:,end);
poolobj = gcp('nocreate');
delete(poolobj)
clearvars x2 p_x2
tic
[x3, p_x3,accept3,pCR3,stepSize3,J3,n_id3] = dreamHParallel(w0',likelihood_fun,prior_fun_MCMC,...
    size(w0,1),ceil(3e5/size(w0,1)), length(finalValues), 'BurnIn', ...
    0,'StepSize',stepSize2,'H', h,'pCR', pCR2,'J', J2, 'n_id', n_id2);
toc

w0 = x3(:,:,end);
tic
[x4, p_x4,accept4,pCR4,stepSize4,J4, n_id4] = dreamHParallel(w0',likelihood_fun,...
    prior_fun_MCMC,size(w0,1),ceil(3e5/size(w0,1)), length(finalValues),...
    'BurnIn', 5e5,'StepSize',stepSize3,'H', h,'pCR', pCR3, 'J', J3, 'n_id', n_id3);
toc

w0 = x4(:,:,end);
tic
[x5, p_x5,accept5,pCR5,stepSize5,J5, n_id5] = dreamHParallel(w0',likelihood_fun,prior_fun_MCMC,...
    size(w0,1),ceil(3e5/size(w0,1)), length(finalValues), 'BurnIn', ...
    3e5,'StepSize',stepSize4,'H', h, 'pCR', pCR4, 'J', J4, 'n_id', n_id4);
toc

w0 = x5(:,:,end);
tic
[x6, p_x6,accept6,pCR6,stepSize6,J6, n_id6] = dreamHParallel(w0',likelihood_fun,prior_fun_MCMC,...
    size(w0,1),ceil(3e5/size(w0,1)), length(finalValues), 'BurnIn', ...
    3e5,'StepSize',stepSize5,'H', h, 'pCR', pCR5, 'J', J5, 'n_id', n_id5);
toc

w0 = x6(:,:,end);
tic
[x7, p_x7,accept7,pCR7,stepSize7,J7, n_id7] = dreamHParallel(w0',likelihood_fun,prior_fun_MCMC,...
    size(w0,1),ceil(3e5/size(w0,1)), length(finalValues), 'BurnIn', ...
    3e5,'StepSize',.4,'H', h, 'pCR', pCR6, 'J', J6, 'n_id', n_id6);
toc

w0 = x7(:,:,end);
tic
[x8, p_x8,accept8,pCR8, stepSize8, J8, n_id8] = dreamHParallel(w0',likelihood_fun,prior_fun_MCMC,...
    size(w0,1),ceil(3e5/size(w0,1)), length(finalValues), 'BurnIn', ...
    3e5,'StepSize',stepSize7,'H', h, 'pCR', pCR7, 'J', J7, 'n_id', n_id7);
toc

w0 = x8(:,:,end);
tic
[x9, p_x9,accept9,pCR9, stepSize9, J9, n_id9] = dreamHParallel(w0',likelihood_fun,prior_fun_MCMC,...
    size(w0,1),ceil(3e5/size(w0,1)), length(finalValues), 'BurnIn', ...
    3e5,'StepSize',stepSize8,'H', h, 'pCR', pCR8, 'J', J8, 'n_id', n_id8);
toc
x=cat(3,x,x2,x3,x4,x5,x6, x7, x8, x9);
p_x = [p_x; p_x2; p_x3; p_x4; p_x5; p_x6; p_x7; p_x8; p_x9];

%% 

covM = cov(postSamples);
R = chol(covM);
X0 = [finalValues; (randn(100, length(finalValues))*0.1)*R + finalValues];
logL=rowfun(obj_fun,table(X0));
[L,I]=sort(logL{:,:});
w0=X0(I(1:N),:);

tic
[x10, p_x10,accept10,pCR10, stepSize10, J10, n_id10] = dreamHParallel(w0,likelihood_fun,prior_fun_MCMC,...
    size(w0,1),ceil(3e5/size(w0,1)), length(finalValues), 'BurnIn', ...
    3e5,'StepSize',2.38^2,'H', h);
toc

w0=x10(:,:,end)';

tic
[x11, p_x11,accept11,pCR11, stepSize11, J11, n_id11] = dreamHParallel(w0,likelihood_fun,prior_fun_MCMC,...
    size(w0,1),ceil(3e5/size(w0,1)), length(finalValues), 'BurnIn', ...
    3e5,'StepSize',stepSize10,'H', h, 'pCR', pCR10, 'J', J10, 'n_id', n_id10);
toc


w0=x11(:,:,end)';

tic
[x12, p_x12,accept12,pCR12, stepSize12, J12, n_id12] = dreamHParallel(w0,likelihood_fun,prior_fun_MCMC,...
    size(w0,1),ceil(3e5/size(w0,1)), length(finalValues), 'BurnIn', ...
    3e5,'StepSize',stepSize10,'H', h, 'pCR', pCR11, 'J', J11, 'n_id', n_id11);
toc

%% Save results
save(strjoin({cd '/PI_CIM21_Control_11_2_DREAM_MCMC_x.mat'},''), 'x')
save(strjoin({cd '/PI_CIM21_Control_11_2_DREAM_MCMC_p_x.mat'},''), 'p_x')

load(strjoin({cd '/CIM_red2_DREAM_MCMC_x.mat'},''))
load(strjoin({cd '/CIM_red2_DREAM_MCMC_p_x.mat'},''))
